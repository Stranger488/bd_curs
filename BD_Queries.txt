1. SELECT Doc_id, Doc_family, COUNT(*) FROM doctor JOIN patient ON (doctor.Doc_id=patient.PDoc_id) WHERE DocDep_id=2 AND YEAR(P_incoming_date)=2017 GROUP BY Doc_id;
2. SELECT Dep_id, Dep_name, Dep_master_family, SUM(R_place_count) FROM department JOIN Room ON (department.Dep_id=room.RDep_id) GROUP BY Dep_id;
3. SELECT * FROM doctor WHERE Doc_enroll_date=(SELECT MIN(Doc_enroll_date) FROM doctor) AND Doc_dismiss_date IS NULL;
4. SELECT * FROM patient WHERE P_incoming_date=(SELECT MIN(P_incoming_date) FROM patient);
5. SELECT * FROM doctor LEFT JOIN patient ON (doctor.Doc_id=patient.PDoc_id) WHERE P_id IS NULL;
6. SELECT Doc_family FROM doctor LEFT JOIN (SELECT * FROM patient WHERE YEAR(P_incoming_date)=2017 AND MONTH(P_incoming_date)=03) p2017_03
	ON (doctor.Doc_id=p2017_03.PDoc_id) WHERE P_id IS NULL;

CREATE DEFINER=`root`@`localhost` PROCEDURE `otch`(in_year integer, in_month integer)
BEGIN
     DECLARE diagn varchar(45);
     DECLARE dep, cnt, AAA integer;
     DECLARE done integer DEFAULT 0;
     DECLARE REP CURSOR FOR SELECT Dep_id, P_diagnosis, COUNT(*) as numb
     FROM department JOIN room ON (Dep_id=RDep_id) JOIN patient ON (R_id=PR_id)
     WHERE YEAR(P_incoming_date)=in_year AND MONTH(P_incoming_date)=in_month
     OR YEAR(P_outcoming_date)=in_year AND MONTH(P_outcoming_date)=in_month
     GROUP BY Dep_id, P_diagnosis;
     DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' SET done=1;
     SELECT COUNT(*) INTO AAA FROM OTCHET
     WHERE O_year=in_year AND O_month=in_month;
     IF AAA=0 THEN
        OPEN REP;
        REPEAT
             FETCH REP INTO `dep`, `diagn`, `cnt`;
             IF done=0 THEN
                INSERT INTO `otchet` VALUES(NULL, `dep`, `in_year`, `in_month`, `diagn`, `cnt`);
             END IF;
        UNTIL done=1
        END REPEAT;
        CLOSE REP;
     SELECT 'success';
     ELSE
     SELECT 'otchet is already exist';
     END IF;
END






//********************************
SELECT Dep_id, P_diagnosis, COUNT(*) as numb
FROM department JOIN room ON (Dep_id=RDep_id) JOIN patient ON (R_id=PR_id)
WHERE YEAR(P_incoming_date)=2017 AND MONTH(P_incoming_date)=01
  OR YEAR(P_outcoming_date)=2017 AND MONTH(P_outcoming_date)=01
GROUP BY Dep_id, P_diagnosis);


SELECT Dep_id, P_diagnosis, AVG(numb) FROM
(SELECT Dep_id, P_diagnosis, COUNT(*) as numb
FROM department JOIN room ON (Dep_id=RDep_id) JOIN patient ON (R_id=PR_id)
WHERE YEAR(P_incoming_date)=2017 AND MONTH(P_incoming_date)=01
  OR YEAR(P_outcoming_date)=2017 AND MONTH(P_outcoming_date)=01
GROUP BY Dep_id, P_diagnosis) as al
GROUP BY Dep_id, P_diagnosis;



DELIMITER $$
CREATE PROCEDURE OTCH(in_year integer, in_month integer)
BEGIN
	DECLARE diagn varchar(45);
	DECLARE dep, cnt, AAA integer;
	DECLARE done integer DEFAULT 0;
	DECLARE REP CURSOR FOR SELECT Dep_id, P_diagnosis, COUNT(*) as numb
	FROM department JOIN room ON (Dep_id=RDep_id) JOIN patient ON (R_id=PR_id)
	WHERE YEAR(P_incoming_date)=2017 AND MONTH(P_incoming_date)=01
	  OR YEAR(P_outcoming_date)=2017 AND MONTH(P_outcoming_date)=01
	GROUP BY Dep_id, P_diagnosis;
	DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' SET done=0;

	SELECT COUNT(*) INTO AAA FROM OTCHET
	WHERE O_year=in_year AND O_month=in_month;

	IF AAA=0 THEN
		OPEN REP;
		WHILE done=0 DO
			FETCH INTO dep, diagn, cnt;
			INSERT INTO otchet VALUES(dep, in_year, in_month, diagn, cnt);
		END WHILE;
		CLOSE REP;

		SELECT 'success';
	ELSE
		SELECT 'otchet's already exist;
	END IF;
END$$


DELIMITER ; $$

//********************************
